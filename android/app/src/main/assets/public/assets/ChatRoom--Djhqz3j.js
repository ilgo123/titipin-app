import{c as y,b as Q,u as Y,a as Z,r,s as d,j as e,L as A,X as ee,n as P}from"./index-ClXmW7HF.js";import{C as te}from"./chevron-left-DLbePdLL.js";import{P as se}from"./package-D4vBBs2Z.js";import{R as ae,S as re,T as ne}from"./truck-gIrrtkXf.js";import{C as ie}from"./camera-BDverxKX.js";import{C as le}from"./circle-check-D5qtfpr7.js";const oe=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],T=y("ellipsis-vertical",oe);const ce=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],de=y("image",ce);const ue=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],xe=y("phone",ue);const me=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],fe=y("send",me);function Ce(){const B=Q(),v=Y(),{user:x}=Z(),l=B.state?.orderId,[R,$]=r.useState([]),[p,z]=r.useState(""),[c,L]=r.useState(null),[O,G]=r.useState(!0),[N,U]=r.useState(!1),[K,I]=r.useState(!1),[k,g]=r.useState(""),[b,h]=r.useState(!1),j=r.useRef(null),w=r.useRef(null),M=r.useRef(null),[he,pe]=r.useState(0),[ge,be]=r.useState(""),[je,W]=r.useState(!1);r.useEffect(()=>{if(!l)return v("/");(async()=>{const{data:s}=await d.from("orders").select("*, requester:requester_id(full_name, avatar_url), traveler:traveler_id(full_name, avatar_url)").eq("id",l).single();L(s);const{data:a}=await d.from("messages").select("*").eq("order_id",l).order("created_at",{ascending:!0});if($(a||[]),s?.status==="done"){const{data:i}=await d.from("reviews").select("id").eq("order_id",l).eq("reviewer_id",x.id).maybeSingle();i&&W(!0)}G(!1)})();const n=d.channel("room-updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`order_id=eq.${l}`},s=>{$(a=>[...a,s.new])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:`id=eq.${l}`},s=>{L(a=>({...a,status:s.new.status}))}).subscribe();return()=>d.removeChannel(n)},[l,v,x.id]),r.useEffect(()=>{M.current?.scrollIntoView({behavior:"smooth"})},[R]);const H=async t=>{t?.preventDefault(),p.trim()&&(await d.from("messages").insert({order_id:l,sender_id:x.id,content:p,type:"text"}),z(""),h(!1))},V=t=>new Promise((n,s)=>{const a=URL.createObjectURL(t),i=new Image;i.src=a,i.onload=()=>{URL.revokeObjectURL(a);const o=document.createElement("canvas"),u=500;let m=i.width,f=i.height;m>f?m>u&&(f*=u/m,m=u):f>u&&(m*=u/f,f=u),o.width=m,o.height=f,o.getContext("2d").drawImage(i,0,0,m,f),o.toBlob(async S=>{if(S)try{const C=await S.arrayBuffer();n({buffer:C,type:S.type})}catch(C){s(C)}else s(new Error("Gagal kompresi"))},"image/jpeg",.6)},i.onerror=o=>{URL.revokeObjectURL(a),s(o)}}),q=async(t,n,s,a=1)=>{try{const{error:i}=await d.storage.from("chat-uploads").upload(n,t,{contentType:s,upsert:!1});if(i)throw i;return!0}catch(i){if(a<=3){const o=a*2e3;return console.warn(`Gagal (Percobaan ${a}). Retry dalam ${o/1e3}s...`),g(`Sinyal putus. Mencoba lagi (${a}/3)...`),await new Promise(u=>setTimeout(u,o)),q(t,n,s,a+1)}else throw i}},D=async t=>{try{h(!1);const n=t.target.files[0];if(!n)return;if(!navigator.onLine){P.error("Kamu sedang offline. Nyalakan internet dulu.");return}I(!0),g("Memproses...");const{buffer:s,type:a}=await V(n);g("Mengirim...");const o=`${`${l}-${Date.now()}-${Math.random().toString(36).substr(2,4)}.jpg`}`;await q(s,o,a);const{data:u}=d.storage.from("chat-uploads").getPublicUrl(o);await d.from("messages").insert({order_id:l,sender_id:x.id,content:u.publicUrl,type:"image"})}catch(n){console.error("Upload Fatal Error:",n),P.error(`Gagal kirim gambar: ${n.message}`)}finally{I(!1),g(""),w.current&&(w.current.value=""),j.current&&(j.current.value="")}},E=async(t,n)=>{U(!0);const{error:s}=await d.from("orders").update({status:t}).eq("id",l);s||await d.from("messages").insert({order_id:l,sender_id:x.id,content:n,type:"text"}),U(!1)},X=()=>{setShowFinishModal(!0)},_=x?.id===c?.requester_id,F=_?c?.traveler:c?.requester,J=_?"Traveler":"Penitip";return O?e.jsx("div",{className:"h-screen flex items-center justify-center",children:e.jsx(A,{className:"animate-spin text-slate-300"})}):e.jsxs("div",{className:"flex flex-col h-[100dvh] bg-[#F0F2F5] relative",children:[e.jsxs("div",{className:"bg-white px-4 py-3 shadow-sm flex items-center justify-between shrink-0 z-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>v(-1),className:"text-slate-500 hover:bg-slate-50 p-1 rounded-full",children:e.jsx(te,{size:24})}),e.jsx("div",{className:"relative",children:e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-gray-200",children:e.jsx("img",{src:F?.avatar_url,className:"w-full h-full object-cover"})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-slate-900 text-sm",children:F?.full_name}),e.jsx("p",{className:"text-xs text-slate-500",children:J})]})]}),e.jsxs("div",{className:"flex gap-2 text-slate-400",children:[e.jsx(xe,{size:20})," ",e.jsx(T,{size:20})]})]}),e.jsxs("div",{className:"bg-white/90 backdrop-blur-md border-b border-slate-100 px-4 py-2 flex items-center justify-between shrink-0 z-10 text-xs shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{size:14,className:"text-orange-500"}),e.jsx("span",{className:"font-bold text-slate-700 max-w-[180px] truncate",children:c?.item})]}),e.jsx("div",{className:`px-2 py-0.5 rounded-md border font-bold text-[10px] uppercase
            ${c?.status==="taken"?"bg-blue-50 text-blue-600 border-blue-100":"bg-gray-100 text-gray-500"}`,children:c?.status})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",onClick:()=>h(!1),children:[R.map(t=>e.jsx("div",{className:`flex ${t.sender_id===x.id?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] px-4 py-2 rounded-2xl text-sm shadow-sm relative ${t.sender_id===x.id?"bg-slate-900 text-white rounded-tr-none":"bg-white text-slate-800 border border-slate-100 rounded-tl-none"}`,children:[t.type==="image"?e.jsx("div",{className:"mb-1",children:e.jsx("img",{src:t.content,alt:"Attachment",className:"rounded-lg w-full max-w-[200px] h-auto object-cover border border-white/20 cursor-pointer",onClick:()=>window.open(t.content,"_blank")})}):e.jsx("p",{children:t.content}),e.jsx("span",{className:`text-[9px] block text-right mt-1 ${t.sender_id===x.id?"opacity-70 text-slate-300":"opacity-50 text-slate-500"}`,children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},t.id)),K&&e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:`px-4 py-2 rounded-2xl rounded-tr-none text-xs flex items-center gap-2 animate-pulse transition-colors ${k.includes("putus")?"bg-red-100 text-red-700":"bg-slate-900 text-white"}`,children:[k.includes("putus")?e.jsx(ae,{size:12,className:"animate-spin"}):e.jsx(A,{size:12,className:"animate-spin"}),k]})}),e.jsx("div",{ref:M})]}),b&&e.jsxs("div",{className:"absolute bottom-20 left-4 z-50 animate-in slide-in-from-bottom-2",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-gray-100 p-2 flex flex-col gap-1 w-40",children:[e.jsxs("button",{onClick:()=>j.current.click(),className:"flex items-center gap-3 px-4 py-3 hover:bg-gray-50 rounded-xl text-slate-700 font-bold text-sm transition-colors text-left",children:[e.jsx("div",{className:"p-2 bg-blue-50 text-blue-600 rounded-full",children:e.jsx(ie,{size:16})}),"Kamera"]}),e.jsxs("button",{onClick:()=>w.current.click(),className:"flex items-center gap-3 px-4 py-3 hover:bg-gray-50 rounded-xl text-slate-700 font-bold text-sm transition-colors text-left",children:[e.jsx("div",{className:"p-2 bg-purple-50 text-purple-600 rounded-full",children:e.jsx(de,{size:16})}),"Galeri"]})]}),e.jsx("div",{className:"w-3 h-3 bg-white border-b border-r border-gray-100 transform rotate-45 absolute -bottom-1.5 left-6"})]}),e.jsxs("div",{className:"px-4 pb-2 bg-[#F0F2F5]",children:[e.jsx("input",{type:"file",accept:"image/*",ref:w,onChange:D,className:"hidden"}),e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:j,onChange:D,className:"hidden"}),c?.status!=="done"&&e.jsx("div",{className:"flex gap-2 mb-2",children:_?(c?.status==="bought"||c?.status==="otw")&&e.jsxs("button",{onClick:X,disabled:N,className:"flex-1 bg-green-600 text-white py-2.5 rounded-xl text-xs font-bold shadow-md hover:bg-green-700 flex items-center justify-center gap-2",children:[e.jsx(le,{size:16})," Terima Barang"]}):e.jsxs(e.Fragment,{children:[c?.status==="taken"&&e.jsxs("button",{onClick:()=>E("bought","ðŸ“¸ Barang sudah dibeli!"),disabled:N,className:"flex-1 bg-purple-600 text-white py-2.5 rounded-xl text-xs font-bold shadow-md hover:bg-purple-700 flex items-center justify-center gap-2",children:[e.jsx(re,{size:16})," Sudah Dibelikan"]}),c?.status==="bought"&&e.jsxs("button",{onClick:()=>E("otw","ðŸ›µ OTW Antar!"),disabled:N,className:"flex-1 bg-orange-500 text-white py-2.5 rounded-xl text-xs font-bold shadow-md hover:bg-orange-600 flex items-center justify-center gap-2",children:[e.jsx(ne,{size:16})," Antar Sekarang"]})]})}),e.jsxs("form",{onSubmit:H,className:"bg-white p-2 border border-slate-200 rounded-full flex items-center gap-2 shadow-sm relative",children:[e.jsx("button",{type:"button",onClick:()=>h(!b),className:`p-2 rounded-full transition-all ${b?"bg-slate-900 text-white rotate-45":"text-slate-400 hover:bg-gray-100"}`,children:b?e.jsx(ee,{size:20}):e.jsx(T,{size:20,className:"rotate-90"})}),e.jsx("input",{type:"text",value:p,onChange:t=>z(t.target.value),placeholder:"Ketik pesan...",className:"flex-1 bg-transparent outline-none text-sm font-medium text-slate-800",onFocus:()=>h(!1)}),e.jsx("button",{type:"submit",disabled:!p.trim(),className:"p-2 bg-slate-900 text-white rounded-full hover:bg-slate-800 disabled:opacity-50",children:e.jsx(fe,{size:16})})]})]})]})}export{Ce as default};
